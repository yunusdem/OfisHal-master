@model TohalBankaHareketi

@{
    ViewBag.title = "Banka Hareket Düzenle";

    ViewBag.pagetitle = "Banka İşlemleri";
    ViewBag.pagesubtitle = "Banka Hareket";
    ViewBag.ptitle = "Banka Hareket Düzenle";
    Layout = "~/Views/Shared/_Layout.cshtml";

    ViewBag.addUrl = "/TohalBankaHareketis/Create";
    ViewBag.saveUrl = "";
    ViewBag.searchUrl = "/Common/BankaHareketler";
    ViewBag.firstDataUrl = "/TohalBankaHareketis/ilkSonKayit?firstOrLast=true";
    ViewBag.beforeDataUrl = "/TohalBankaHareketis/sonrakiOncekiKayit?afterOrBefore=false&currentId=" + Model.BankaHareketiId;
    ViewBag.afterDataUrl = "/TohalBankaHareketis/sonrakiOncekiKayit?afterOrBefore=true&currentId=" + Model.BankaHareketiId;
    ViewBag.lastDataUrl = "/TohalBankaHareketis/ilkSonKayit?firstOrLast=false";
    ViewBag.disabledBeforeAfter = false;
}
<style>
    .choices__inner {
        min-height: 0;
        font-size: .750rem;
    }

    .choices__list--single {
        padding: 0;
    }
</style>
@Html.Partial("~/Views/Shared/_dataNavigator.cshtml")
<form method="post" action="@Url.Action("Edit")">
    @Html.AntiForgeryToken()
    <input type="hidden" id="BankaHareketiId" name="BankaHareketiId" value="@Model.BankaHareketiId" />
    <div class="row">
        <div class="col-lg-5">
            <div class="row">
                <label for="IslemTipi" class="col-sm-3 col-form-label pb-0">İşlem Tipi</label>
                <div class="col-sm-9">
                    <select name="IslemTipi" class="form-control form-control-sm" id="IslemTipi" value="@Model.IslemTipi">
                        <option value="0" @(Model.IslemTipi == 0 ? "selected" : "")>Havale Alma</option>
                        <option value="1" @(Model.IslemTipi == 1 ? "selected" : "")>Havale Gönderme</option>
                        <option value="2" @(Model.IslemTipi == 2 ? "selected" : "")>Para Çekme</option>
                        <option value="3" @(Model.IslemTipi == 3 ? "selected" : "")>Para Yatırma</option>
                        <option value="4" @(Model.IslemTipi == 4 ? "selected" : "")>Virman</option>
                        <option value="5" @(Model.IslemTipi == 5 ? "selected" : "")>POS Hesabından Aktar</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <input type="hidden" id="BankaHesabiId" name="BankaHesabiId" value="@Model.BankaHesabiId" />
                <label for="bankaHesapNo" class="col-sm-3 col-form-label pb-0">
                    Hesap No
                </label>
                <div class="col-sm-9">
                    <div class="input-group">
                        <input type="text" id="bankaHesapNo" name="bankaHesapNo" class="form-control form-control-sm" data-id="@Model.BankaHesabiId" value="@Model.BankaHesabi.HesapNo" />
                        <button type="button" data-btarget="bankahesapno" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal" data-label="Seç" data-remote-url="@Url.Action("BankaHesapNumaralar", "Common", new { target = "bankaHesapNo", inputType = "num", isInput = true })">
                            Seç
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <label for="bankaHesapAdi" class="col-sm-3 col-form-label pb-0">
                    Hesap Adı
                </label>
                <div class="col-sm-9">
                    <div class="input-group">
                        <input type="text" id="bankaHesapAdi" name="bankaHesapAdi" class="form-control form-control-sm" data-id="@Model.BankaHesabiId" value="@Model.BankaHesabi.HesapAdi" />
                        <button type="button" data-btarget="bankahesapad" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal" data-label="Seç" data-remote-url="@Url.Action("BankaHesapAdlar", "Common", new { target = "bankaHesapAdi", inputType = "name", isInput = true })">
                            Seç
                        </button>
                    </div>
                </div>
            </div>
            @*hide show*@
            <div id="posCihazDiv">
                <input type="hidden" id="PosCihaziId" name="PosCihaziId" value="@(Model.PosCihaziId != null ? Model.PosCihaziId : null)"/>
                <div class="row">
                    <label for="hidPosCihaziId" class="col-sm-3 col-form-label pb-0">POS Cihazı</label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" id="hidPosCihaziId" name="hidPosCihaziId" class="form-control form-control-sm" data-id="@(Model.PosCihaziId != null ? Model.PosCihaziId : null)" value="@(Model.PosCihaziId != null ? Model.PosCihazi.Ad: null)" />
                            <button type="button" data-btarget="posid" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal" data-label="Seç" data-remote-url="@Url.Action("PosCihazlar", "Common", new { target = "hidPosCihaziId" })">
                                Seç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            @*hide show KASA HESABI*@
            <div id="HesapIdDiv">
                <input type="hidden" id="HesapId" name="HesapId" value="@(Model.HesapId != null ? Model.HesapId : null)" />
                <div class="row">
                    <label for="hidHesapId" class="col-sm-3 col-form-label pb-0">Kasa Hesabı</label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" id="hidHesapId" name="hidHesapId" class="form-control form-control-sm" data-id="@(Model.HesapId != null ? Model.HesapId : null)" value="@(Model.HesapId != null ? Model.Hesap.Ad: null)" />
                            <button type="button" data-btarget="hesapid" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal" data-label="Seç" data-remote-url="@Url.Action("HesapAdlar", "Common", new { target = "hidHesapId", isCode = false, inputType = "name", isInput = true })">
                                Seç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            @*hide show *@
            <div id="cariKartDiv">
                <input type="hidden" id="CariKartId" name="CariKartId" value="@(Model.CariKartId != null ? Model.CariKartId : null)" />
                <div class="row">
                    <label for="hidCariKartId" class="col-sm-3 col-form-label pb-0">Cari Adı</label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" id="hidCariKartId" name="hidCariKartId" class="form-control form-control-sm" data-id="@(Model.CariKartId != null ? Model.CariKartId : null)" value="@(Model.CariKartId != null ? Model.CariKart.Ad: null)" />
                            <button type="button" data-btarget="carikartid" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal" data-label="Seç" data-remote-url="@Url.Action("Sahipler", "Common", new { target = "hidCariKartId", isCode = false, isInput = true, inputType = "name" })">
                                Seç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            @*hide show *@
            <div id="KarsiBankaHesabiDiv">
                <input type="hidden" id="KarsiBankaHesabiId" name="KarsiBankaHesabiId" value="@(Model.KarsiBankaHesabiId != null ? Model.KarsiBankaHesabiId : null)" />
                <div class="row">
                    <label for="hidKarsiBankaHesabiId" class="col-sm-3 col-form-label pb-0">Karşı Hesap</label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" id="hidKarsiBankaHesabiId" name="hidKarsiBankaHesabiId" class="form-control form-control-sm" data-id="@(Model.KarsiBankaHesabiId != null ? Model.KarsiBankaHesabiId : null)" value="@(Model.KarsiBankaHesabiId != null ? Model.KarsiBankaHesabi.HesapAdi: null)" />
                            <button type="button" data-btarget="karsibankahesapid" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal" data-label="Seç" data-remote-url="@Url.Action("BankaHesapAdlar", "Common", new { target = "hidKarsiBankaHesabiId", inputType = "name", isInput = true })">
                                Seç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <label for="Tarih" class="col-sm-3 col-form-label pb-0">Tarih</label>
                <div class="col-sm-9">
                    <input type="date" id="Tarih" name="Tarih" class="form-control form-control-sm" value="@Model.Tarih.ToString("yyyy-MM-dd")" />
                    <span class="text-danger">@Html.ValidationMessageFor(model => model.Tarih)</span>
                </div>
            </div>
            <div class="row">
                <label for="Aciklama" class="col-sm-3 col-form-label pb-0">Açıklama</label>
                <div class="col-sm-9">
                    <input id="Aciklama" name="Aciklama" class="form-control form-control-sm" value="@Model.Aciklama" />
                    <span class="text-danger">@Html.ValidationMessageFor(model => model.Aciklama)</span>
                </div>
            </div>
            <div class="row">
                <label for="Meblag" class="col-sm-3 col-form-label pb-0">Meblağ</label>
                <div class="col-sm-9">
                    <input type="text" data-type="num" id="Meblag" name="Meblag" class="form-control form-control-sm" value="@Model.Meblag" />
                    <span class="text-danger">@Html.ValidationMessageFor(model => model.Meblag)</span>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <input type="submit" value="Kaydet" class="btn btn-primary" />
        </div>
    </div>
</form>
<div class="modal fade" id="modal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalLabel"></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Kapat
                </button>
                <button id="modalSaveBtn" type="button" class="btn btn-primary">
                    Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script src="~/assets/customscripts/sharedfuncs.js"></script>
    <script>
        var target = "";
        $(document).on("show.bs.modal", "#modal", function (e) {
            var btn = $(e.relatedTarget);
            var container = $("#modalContent");
            var label = $("#modalLabel");

            container.empty();
            label.empty();

            if (btn.data("remote-url")) {
                target = btn.data("btarget");
                container.load(btn.data("remote-url"));
                label.text(btn.data("label"))
            } else {
                target = e.relatedTarget.target;
            }
        });

        $(document).on("hidden.bs.modal", "#modal", function (e) {
            $("#modalContent").empty();
            $("#modalLabel").empty();
            switch (target) {
                case "bankahesapad": updateNumber(); break;
                case "bankahesapno": updateName(); break;
                case "posid":
                    document.getElementById("hidPosCihaziId").getAttribute("data-id") > 0 ? $("#PosCihaziId").val(document.getElementById("hidPosCihaziId").getAttribute("data-id")) : $("#PosCihaziId").val(null);
                    break;
                case "hesapid":
                    document.getElementById("hidHesapId").getAttribute("data-id") > 0 ? $("#HesapId").val(document.getElementById("hidHesapId").getAttribute("data-id")) : $("#HesapId").val(null);
                    break;
                case "carikartid":
                    document.getElementById("hidCariKartId").getAttribute("data-id") > 0 ? $("#CariKartId").val(document.getElementById("hidCariKartId").getAttribute("data-id")) : $("#CariKartId").val(null);
                    break;
                case "karsibankahesapid":
                    document.getElementById("hidKarsiBankaHesabiId").getAttribute("data-id") > 0 ? $("#KarsiBankaHesabiId").val(document.getElementById("hidKarsiBankaHesabiId").getAttribute("data-id")) : $("#KarsiBankaHesabiId").val(null);
                    break;
                case "arabtn":
                    sessionStorage.getItem('bankaHareketId') > 0 ? window.location.href = `/TohalBankaHareketis/Edit/${sessionStorage.getItem('bankaHareketId')}` : null;
                    sessionStorage.removeItem("bankaHareketId");
                    break;
            }
        });

        function updateNumber() {
            var idVal = document.getElementById("bankaHesapAdi").getAttribute("data-id");
            idVal ? getById("/Common/getBankaHesapById", parseInt(idVal), $("#bankaHesapNo"), "HesapNo") : null;
        }
        function updateName() {
            var idVal = document.getElementById("bankaHesapNo").getAttribute("data-id");
            idVal ? getById("/Common/getBankaHesapById", parseInt(idVal), $("#bankaHesapAdi"), "HesapAdi") : null;
        }
        function getById(url, idval, elm, nameOrNumber) {
            $.ajax({
                url: url,
                type: "GET",
                data: { id: idval },
                cache: false,
                success: (res) => {
                    $(elm).val(res[nameOrNumber]);
                    $(elm).attr("data-id", res.BankaHesabiId);
                    $("#BankaHesabiId").val(res.BankaHesabiId);
                }
            });
        }

        $("#bankaHesapNo").on("focusout", async function (e) {
            var val = await getData($(this), "/Common/BankaHesapGetir?isInput=True&target=bankaHesapNo&nameOrNumber=false&inputType=num", "HesapNo", "BankaHesabiId", e, null, "bankahesapno");
            val.result ? updateName() : null;
        });
        $("#bankaHesapAdi").on("focusout", async function (e) {
            var val = await getData($(this), "/Common/BankaHesapGetir?isInput=True&target=bankaHesapAdi&nameOrNumber=true&inputType=name", "HesapAdi", "BankaHesabiId", e, null, "bankahesapad");
            val.result ? updateNumber() : null;
        });
        $("#hidPosCihaziId").on("focusout", async function (e) {
            var val = await getData($(this), "/Common/PosCihazGetir?target=hidPosCihaziId", "Ad", "PosCihaziId", e, null, "posid");
            val.result ? $("#PosCihaziId").val(val.data.PosCihaziId) : $("#PosCihaziId").val(null);
        });
        $("#hidHesapId").on("focusout", async function (e) {
            var val = await getData($(this), "/Common/HesapGetir?isInput=True&inputType=name&target=hidHesapId&codeOrName=false", "Ad", "HesapId", e, null, "hesapid");
            val.result ? $("#HesapId").val(val.data.HesapId) : $("#HesapId").val(null);
        });
        $("#hidCariKartId").on("focusout", async function (e) {
            var val = await getData($(this), "/Common/cariGetir?isInput=True&target=hidCariKartId&butunCari=true&tip=0&codeOrName=false&inputType=name", "Ad", "CariKartId", e, null, "carikartid");
            val.result ? $("#CariKartId").val(val.data.CariKartId) : $("#CariKartId").val(null);
        });
        $("#hidKarsiBankaHesabiId").on("focusout", async function (e) {
            var val = await getData($(this), "/Common/BankaHesapGetir?isInput=True&target=hidKarsiBankaHesabiId&nameOrNumber=true&inputType=name", "HesapAdi", "BankaHesabiId", e, null, "karsibankahesapid");
            val.result ? $("#KarsiBankaHesabiId").val(val.data.BankaHesabiId) : $("#KarsiBankaHesabiId").val(null);
        });

        // 0 Havale Alma
        // 1 Havale Gönderme
        // 2 Para Çekme
        // 3 Para Yatırma
        // 4 Virman
        // 5 POS Hesabından Aktar

        var islemTipi = document.getElementById("IslemTipi");

        var posCihazDiv = document.getElementById("posCihazDiv");
        var HesapIdDiv = document.getElementById("HesapIdDiv");
        var cariKartDiv = document.getElementById("cariKartDiv");
        var KarsiBankaHesabiDiv = document.getElementById("KarsiBankaHesabiDiv");

        updateDisplayFileds(islemTipi.value);
        islemTipi.addEventListener("change", function (e) {
            updateDisplayFileds(e.target.value);
        });
        function updateDisplayFileds(val) {
            switch (val) {
                case "0": HideShowDivs(false, false, true, false);; break;
                case "1": HideShowDivs(false, true, true, false); break;
                case "2": HideShowDivs(false, false, false, false); break;
                case "3": HideShowDivs(false, false, false, false); break;
                case "4": HideShowDivs(false, false, false, true); break;
                case "5": HideShowDivs(true, false, false, false); break;
            }
        }
        function HideShowDivs(posDiv, hesapDiv, cariDiv, karsiBankaDiv) {

            if (posDiv) {
                posCihazDiv.style.display = "block";
            } else {
                posCihazDiv.style.display = "none";
                document.getElementById("PosCihaziId").value = null;
                document.getElementById("hidPosCihaziId").value = null;
            }

            if (hesapDiv) {
                HesapIdDiv.style.display = "block";
            } else {
                HesapIdDiv.style.display = "none";
                document.getElementById("HesapId").value = null;
                document.getElementById("hidHesapId").value = null;
            }

            if (cariDiv) {
                cariKartDiv.style.display = "block";
            } else {
                cariKartDiv.style.display = "none";
                document.getElementById("CariKartId").value = null;
                document.getElementById("hidCariKartId").value = null;
            }

            if (karsiBankaDiv) {
                KarsiBankaHesabiDiv.style.display = "block";
            } else {
                KarsiBankaHesabiDiv.style.display = "none";
                document.getElementById("KarsiBankaHesabiId").value = null;
                document.getElementById("hidKarsiBankaHesabiId").value = null;
            }
        }
    </script>
}
