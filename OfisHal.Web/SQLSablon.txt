

----TOHAL_HKS_MAL  SİLİNİYOR
SET QUOTED_IDENTIFIER ON 
GO

SET ANSI_NULLS ON
GO

DELETE FROM TOHAL_MAL_HKS_BAGI
GO

DELETE FROM TOHAL_HKS_MAL
GO

DBCC CHECKIDENT (TOHAL_HKS_MAL, reseed,1)
GO

----

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URETIM_SEKILLERI_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URETIM_SEKILLERI_TABLE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URUN_BIRIMLERI_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URUN_BIRIMLERI_TABLE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URUN_CINSLERI_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URUN_CINSLERI_TABLE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URUNLER_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URUNLER_TABLE]
GO

----HKS ÜRÜNLERİ TABLOSU OLUŞTUR--------


/****** Object:  Table [dbo].[HKS_URUNLER_TABLE]    Script Date: 05/07/2014 10:28:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[HKS_URUNLER_TABLE](
	[ID] [int] NULL,
	[AD] [varchar](500) NULL
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
{{URUNLER}}
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[HKS_URUN_CINSLERI_TABLE](
	[ID] [int] NULL,
	[AD] [varchar](500) NULL,
	[URETIM_SEKLI_ID] [int] NULL,
	[URUN_ID] [int] NULL,
	[URUN_KODU] [varchar](500) NULL
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
{{CINSLER}}
GO



/****** Object:  Table [dbo].[HKS_URUN_BIRIMLERI_TABLE]    Script Date: 03/17/2014 16:59:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[HKS_URUN_BIRIMLERI_TABLE](
	[ID] [int] NULL,
	[AD] [varchar](500) NULL
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
INSERT [dbo].[HKS_URUN_BIRIMLERI_TABLE] ([ID], [AD]) VALUES (73, CONVERT(TEXT, N'Adet'))
INSERT [dbo].[HKS_URUN_BIRIMLERI_TABLE] ([ID], [AD]) VALUES (74, CONVERT(TEXT, N'Kg'))
INSERT [dbo].[HKS_URUN_BIRIMLERI_TABLE] ([ID], [AD]) VALUES (76, CONVERT(TEXT, N'Bağ'))




/****** Object:  Table [dbo].[HKS_URETIM_SEKILLERI_TABLE]    Script Date: 03/17/2014 16:59:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[HKS_URETIM_SEKILLERI_TABLE](
	[ID] [int] NULL,
	[AD] [varchar](500) NULL
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
INSERT [dbo].[HKS_URETIM_SEKILLERI_TABLE] ([ID], [AD]) VALUES (28, CONVERT(TEXT, N'Geleneksel(Konvansiyonel)'))
INSERT [dbo].[HKS_URETIM_SEKILLERI_TABLE] ([ID], [AD]) VALUES (29, CONVERT(TEXT, N'Organik Tarım'))
INSERT [dbo].[HKS_URETIM_SEKILLERI_TABLE] ([ID], [AD]) VALUES (30, CONVERT(TEXT, N'İyi Tarım'))




-- ÜRÜNLERİN ATANMASI
UPDATE M SET M.HKS_ID = HKS.ID
FROM HKS_URUNLER_TABLE HKS INNER JOIN TOHAL_HKS_MAL M ON HKS.AD = M.AD 
WHERE M.TUR = 0 AND M.UST_ID IS NULL AND M.HKS_ID IS NULL
GO 

INSERT INTO TOHAL_HKS_MAL(UST_ID, TUR, AD, URETIM_SEKLI, BIRIM, HKS_ID)
SELECT NULL, 0, HKS.AD, NULL, NULL, HKS.ID
FROM HKS_URUNLER_TABLE HKS LEFT OUTER JOIN TOHAL_HKS_MAL M ON HKS.AD = M.AD AND M.TUR = 0 AND M.UST_ID IS NULL
WHERE M.HKS_MAL_ID IS NULL
GO




-- ÜRÜN CİNSLERİNİN ATANMASI

DECLARE @URUN_CINSI_ID INT
DECLARE @URUN_CINSI_ADI VARCHAR(50)
DECLARE @URETIM_SEKLI_ID INT
DECLARE @URUN_ID INT
DECLARE @URUN_KODU VARCHAR(50)

DECLARE @UST_ID INT

IF EXISTS (SELECT * FROM HKS_URUN_CINSLERI_TABLE WHERE URETIM_SEKLI_ID IN (28,29,30))
	UPDATE HKS_URUN_CINSLERI_TABLE SET URETIM_SEKLI_ID = CASE WHEN URETIM_SEKLI_ID = 28 THEN 0 WHEN URETIM_SEKLI_ID = 29 THEN 1 WHEN URETIM_SEKLI_ID = 30 THEN 2 END 


SET @UST_ID = NULL	

DECLARE C_URUN_CINS CURSOR LOCAL FOR
	SELECT ID, AD, URETIM_SEKLI_ID, URUN_ID, URUN_KODU
	FROM HKS_URUN_CINSLERI_TABLE
	
OPEN C_URUN_CINS
FETCH NEXT FROM C_URUN_CINS INTO @URUN_CINSI_ID, @URUN_CINSI_ADI, @URETIM_SEKLI_ID, @URUN_ID, @URUN_KODU
	

WHILE @@FETCH_STATUS =  0
BEGIN	

	IF EXISTS(
			SELECT * 
			FROM TOHAL_HKS_MAL URUN 
				INNER JOIN TOHAL_HKS_MAL CINS ON URUN.HKS_MAL_ID = CINS.UST_ID 
			WHERE CINS.AD = @URUN_CINSI_ADI AND CINS.TUR = 1 AND URUN.HKS_ID = @URUN_ID --AND CINS.UST_ID = @URUN_ID 
				AND CINS.URETIM_SEKLI = @URETIM_SEKLI_ID 
		)
		UPDATE CINS SET HKS_ID = @URUN_CINSI_ID, HKS_URUN_KODU = @URUN_KODU
		FROM TOHAL_HKS_MAL URUN
			INNER JOIN TOHAL_HKS_MAL CINS ON URUN.HKS_MAL_ID = CINS.UST_ID 
		WHERE CINS.AD = @URUN_CINSI_ADI AND CINS.TUR = 1 AND URUN.HKS_ID = @URUN_ID  AND CINS.URETIM_SEKLI = @URETIM_SEKLI_ID 
	ELSE
	BEGIN			
		
		SELECT TOP 1 @UST_ID = URUN.HKS_MAL_ID	
		FROM TOHAL_HKS_MAL URUN
		WHERE URUN.TUR = 0 AND URUN.HKS_ID =  @URUN_ID 
	
		INSERT INTO TOHAL_HKS_MAL (UST_ID, TUR, AD, URETIM_SEKLI, HKS_ID, HKS_URUN_KODU)	
			VALUES(@UST_ID, 1, @URUN_CINSI_ADI, @URETIM_SEKLI_ID, @URUN_CINSI_ID, @URUN_KODU)
	END		

	FETCH NEXT FROM C_URUN_CINS INTO @URUN_CINSI_ID, @URUN_CINSI_ADI, @URETIM_SEKLI_ID, @URUN_ID, @URUN_KODU
END

CLOSE C_URUN_CINS
DEALLOCATE C_URUN_CINS


GO



if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URETIM_SEKILLERI_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URETIM_SEKILLERI_TABLE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URUN_BIRIMLERI_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URUN_BIRIMLERI_TABLE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URUN_CINSLERI_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URUN_CINSLERI_TABLE]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[HKS_URUNLER_TABLE]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [dbo].[HKS_URUNLER_TABLE]
GO